@page "/kitchen"
@using BlazingPizza.Shared
@using System.Text.Json
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@inject IRepository PizzaStore
@inject IJSRuntime JSRuntime
@inject OrderState OrderState
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageTitle>Blazing Pizza - Kitchen</PageTitle>

<Microsoft.AspNetCore.Components.Authorization.AuthorizeView Roles="Cook">

<div class="main">

   <OrderFilter OnPreferenceChanged="OnPreferenceChanged" />

	<div>
		@if (OrdersWithStatus is null)
		{
			<p><em>Loading...</em></p>
		}
		else
		{
			<table class="table">
				<thead>
					<tr>
						<th>Pizza</th>
						<th>Status</th>
						<th>Action</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var orderWithStatus in OrdersWithStatus)
					{
							@foreach (var pizza in orderWithStatus.Order.Pizzas)
							{
								<tr>
									<td>
										<div><strong>@(pizza.Special?.Name ?? "Custom pizza")</strong> — £@pizza.GetFormattedTotalPrice()</div>
										@if (pizza.Toppings?.Any() == true)
										{
											<div class="small text-muted">
												Toppings:
												@string.Join(", ", pizza.Toppings.Select(t => t.Topping?.Name ?? "(unknown)"))
											</div>
										}
									</td>
									<td>@orderWithStatus.Order.Status</td>
									<td>																			
										<button type="button" class="btn btn-warning" @onclick="@(() => UpdateOrderStatusAsync(orderWithStatus.Order.OrderId, PizzaOrderStatus.Preparing))" style="font-weight: bold">Mark as Preparing</button>
										<button type="button" class="btn btn-success" @onclick="@(() => UpdateOrderStatusAsync(orderWithStatus.Order.OrderId, PizzaOrderStatus.OutForDelivery))" style="font-weight: bold">Out for Delivery</button>
									</td>
								</tr>
							}
							
					}
				</tbody>
			</table>
		}
	</div>
</div>
	
	

</Microsoft.AspNetCore.Components.Authorization.AuthorizeView>
@code {

	[Parameter]
	public List<OrderWithStatus>? OrdersWithStatus { get; set; }

	Pizza? Pizza;

	private bool _initialLoadDone = false;

	//Never call JS interop in OnInitialized or OnInitializedAsync. Use OnAfterRenderAsync with the firstRender flag for such logic. 
    //get vegetarian orders from local storage if any exists

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender && !_initialLoadDone)
		{
			_initialLoadDone = true;
			OrdersWithStatus = await PizzaStore.GetOrdersAsync();		

			StateHasChanged(); 
		}
	}

	async Task<List<OrderWithStatus>> GetVegetarianOrdersFromLocalStorage()
	{
		var vegetarianOrdersJson = await JSRuntime.InvokeAsync<string?>("blazorLocalStorage.get", "vegetarianPizza");
		if (!string.IsNullOrEmpty(vegetarianOrdersJson))
		{
			OrdersWithStatus = JsonSerializer.Deserialize<List<OrderWithStatus>>(vegetarianOrdersJson);
			return OrdersWithStatus ?? new List<OrderWithStatus>();
		}
		return new List<OrderWithStatus>();
	}


	// public async Task LoadPizzaDetails(Pizza? pizza)
	// {
	// 	Pizza = pizza;
	// 	// ensure UI updated before showing modal
	// 	await InvokeAsync(StateHasChanged);
	// 	// show Bootstrap modal programmatically
	// 	await JSRuntime.InvokeVoidAsync("eval", "bootstrap.Modal.getOrCreateInstance(document.getElementById('exampleModal')).show()");
	// }

	// wired to <select>@onchange
	async Task OnPreferenceChanged(ChangeEventArgs e)
	{
		var selected = e?.Value?.ToString();
		await GetOrdersByPreferenceAsync(selected);
	}


	async Task GetOrdersByPreferenceAsync(string? preference)
	{
		if(OrdersWithStatus is null || string.IsNullOrEmpty(preference))
		{
			return;
		}

		if (string.Equals(preference, "Vegetarian", StringComparison.OrdinalIgnoreCase))
		{
			var vegetarianOrdersFromLocalStorage = await GetVegetarianOrdersFromLocalStorage();

			if(vegetarianOrdersFromLocalStorage != null && vegetarianOrdersFromLocalStorage.Any())
			{
				OrdersWithStatus = vegetarianOrdersFromLocalStorage;
			}
			else
			{
				//key words to filter vegetarian pizzas
				var terms = new[] { "Margherita", "Veggie", "Mushroom" };

				var vegetarianOrders = OrdersWithStatus
					.Where(o => o.Order?.Pizzas?.Any(p =>
						!string.IsNullOrEmpty(p.Special?.Name) &&
						terms.Any(t => p.Special!.Name.Contains(t, StringComparison.OrdinalIgnoreCase))
					) == true)
					.ToList();

				// save filtered list
				await JSRuntime.InvokeVoidAsync("blazorLocalStorage.set", "vegetarianPizza", JsonSerializer.Serialize<List<OrderWithStatus>>(vegetarianOrders));

				OrdersWithStatus = vegetarianOrders;
			}
			
		}
		else
		{
			OrdersWithStatus = await PizzaStore.GetOrdersAsync();
		}
	}

	private async Task UpdateOrderStatusAsync(int orderId, string status)
	{
		if (!string.IsNullOrEmpty(status))
		{
			await PizzaStore.UpdateOrderStatusAsync(new UpdateOrderStatusDto { OrderId = orderId, Status = status });
		}
		
		StateHasChanged();
	}

}